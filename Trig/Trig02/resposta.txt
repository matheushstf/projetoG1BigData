CREATE OR REPLACE FUNCTION DELETE_RESERVA()
RETURNS TRIGGER AS
$BODY$
DECLARE
	C_PEDIDO INTEGER;
	C_ESPETACULO INTEGER; 
	C_SESSAO INTEGER;
	C_CADEIRA VARCHAR;
BEGIN
	SELECT R.COD_PEDIDO, R.COD_ESPETACULO, R.COD_SESSAO, R.CADEIRA FROM RESERVA AS R
	WHERE R.COD_RESERVA = OLD.COD_RESERVA INTO C_PEDIDO, C_ESPETACULO, C_SESSAO, C_CADEIRA;
	INSERT INTO HISTORICO_RESERVA(COD_PEDIDO, COD_ESPETACULO, COD_SESSAO, CADEIRA, DATA_OPERACAO)
	VALUES(C_PEDIDO, C_ESPETACULO, C_SESSAO, C_CADEIRA, NOW());
	DELETE FROM RESERVA AS R
	WHERE R.COD_RESERVA = OLD.COD_RESERVA;
	RETURN NEW.COD_RESERVA;
END;
$BODY$
LANGUAGE PLPGSQL;

CREATE TRIGGER HIST_RESERVA
BEFORE DELETE 
ON RESERVA
FOR EACH ROW WHEN(pg_trigger_depth()=0)
EXECUTE PROCEDURE DELETE_RESERVA();

DELETE FROM RESERVA WHERE COD_RESERVA = 3567